<!--
	Author : Ram Kulkarni
			 http://ramkulkarni.com

	+ modifications by Tom Gibson
-->

<div data-role="dialog" id="rk_file_dialog">
	
	<style media="screen" type="text/css">
		.file_icon{
			font-size:x-large;
			font-weight:bolder;
			/*background-color:#AAA;*/
			vertical-align:top;	
		}
		
		.small_btn {
			font-size:medium;
		}	
		
		.file_list_row {
			font-size:x-large;
		}
	</style>

      <style>

        .ui-page{
            top: 0;
            left: 0;
            position: absolute;
            width: 100%;
            border: 0;
            padding: 0;
            margin: 0;
        }

        #FileBrowserHeader{
          text-align: center;
        }

        #FileBrowserTitleBar{
          font-size: 1.5em;
          font-weight: bold;
          color: #333;
        }

        .EntryTypeIcon{
          width: 20px;
          height: 20px;
          margin: 0;
        }

		.ui-btn{
			color: blue;
			font-weight: bold;
		}

        .ui-dialog-contain{
          width: 92.5%;
          max-width: 100%;
          margin: 10% auto 1em auto;
          padding: 0;
          box-shadow: 0 0 12px rgba(0,0,0,.6);
        }

        .ui-dialog{
            background-color: white;
            color: #333;
            text-shadow: 0 1px 0 #f3f3f3;

            font-size: 1em;
            line-height: 1.3;
            font-family: sans-serif;
        }

        .ui-corner-all{
          background-clip: padding-box;
          border-radius: .3125em /*{global-radii-blocks}*/
        }
      </style>
	
	<div data-role="header" id="FileBrowserHeader">
		<h2 id="FileBrowserTitleBar">File Chooser</h2>
	</div>
	<div data-role="content">
		<b><span id="curr_folder"></span></b><br/>
		<a href="#" data-role="button" data-inline="true" id="new_file_btn" data-theme="b" class="small_btn">New File</a>
		<span>  </span> <!-- I just put this here to give a small space / kinda ugly & could use cleaning up -->
		<a href="#" data-role="button" data-inline="true" id="new_dir_btn" data-theme="b" class="small_btn">New Dir</a>
		
		<div id="fileBrowser_entries"></div>
		
		<a href="#" id="file_browser_ok" data-role="button" data-rel="back" data-theme="b" data-inline="true" id="file_browser_ok">OK</a>
		<!--  I removed this because it wasn't triggering the pagehide event & user can use the top close link/button instead'
		<a href="#" data-role="button" data-rel="back" data-theme="b" data-inline="true" id="file_browser_cancel">Cancel</a>       
		-->
	</div>

	<script language="JavaScript">
		var currPath = "";
		var currEntry = null;
		var bClosingDialogByCallbackRequest = false;
		
		if (typeof file_Browser_params == 'undefined')
			file_Browser_params = new Object();
			
		if (typeof file_Browser_params.directory_browser != 'boolean')
			file_Browser_params.directory_browser = false;

		if (typeof file_Browser_params.on_folder_select != 'function')
			file_Browser_params.on_folder_select = null;

		if (typeof file_Browser_params.on_file_select != 'function')
			file_Browser_params.on_file_select = null;
			
		if (typeof file_Browser_params.on_ok != 'function')
			file_Browser_params.on_ok = null;
			
		if (typeof file_Browser_params.new_file_btn == 'undefined')
			file_Browser_params.new_file_btn = true;

		if (typeof file_Browser_params.new_folder_btn == 'undefined')
			file_Browser_params.new_folder_btn = true;

		if (typeof file_Browser_params.ok_btn == 'undefined')
			file_Browser_params.ok_btn = true;

		if (typeof file_Browser_params.default_fileName == 'undefined')
			file_Browser_params.default_fileName = "untitled.txt";


		if (typeof file_Browser_params.custom_title == 'undefined')
			file_Browser_params.custom_title = null;

		if (typeof file_Browser_params.confirm_selected_file == 'undefined')
			file_Browser_params.confirm_selected_file = false;

		// Automaticaly appends " (filename)" before displaying
		if (typeof file_Browser_params.confirm_selected_file_prompt == 'undefined')
			file_Browser_params.confirm_selected_file_prompt = "Are you sure you want to select this file?";

		if (typeof file_Browser_params.on_cancel_file_select != 'function')
			file_Browser_params.on_cancel_file_select = null;


		function init()
		{
			if (!file_Browser_params.new_file_btn)
				$("#new_file_btn").hide();

			if (!file_Browser_params.new_folder_btn)
				$("#new_dir_btn").hide();

			if (!file_Browser_params.ok_btn)
				$("#file_browser_ok").hide();

			if (typeof(file_Browser_params.custom_title) == 'string') {
				$("#FileBrowserTitleBar").text(file_Browser_params.custom_title);
			}

			
			$("#new_file_btn").click(function(){
				if (currEntry == null)
					return;
					
				var fileName = prompt("Enter File Name", file_Browser_params.default_fileName);
				if (fileName == null || fileName == '')
					return;
				currEntry.getFile(fileName,{create:false},function(){
					alert("File already exists");
				}, 
				function(){
					currEntry.getFile(fileName,{create:true}, function(){
						//refresh current folder
						getEntries(currEntry);
					}, function(){
						alert("Error creating file " + fileName);
					});
				});
			});
			
			$("#new_dir_btn").click(function(){
				if (currEntry == null)
					return;
				var fileName = prompt("Enter Folder Name","untitled");
				if (fileName == null || fileName == '')
					return;
				currEntry.getDirectory(fileName,{create:false},function(){
					alert("Folder already exists");
				}, 
				function(){
					currEntry.getDirectory(fileName,{create:true}, function(){
						//refresh current folder
						getEntries(currEntry);
					}, function(){
						alert("Error creating file " + fileName);
					});
				});
			});
			
			$("#file_browser_ok").click(function(){
				if (file_Browser_params.on_ok == null)
					return;
				file_Browser_params.on_ok(currEntry);
			});
			
			if (typeof file_Browser_params.initial_folder == 'undefined' ||
				file_Browser_params.initial_folder == null)
			{
				file_Browser_params.initial_folder = null;
				getRootAndDisplay();
			} 
			else
			{
				var url = file_Browser_params.initial_folder.nativeURL;
				window.resolveLocalFileSystemURL(url);
				getEntries(file_Browser_params.initial_folder);
			}

			$("#rk_file_dialog").bind("pagehide",function(){
				if( !bClosingDialogByCallbackRequest ) {
					if( file_Browser_params.on_cancel_file_select != null ) {
						file_Browser_params.on_cancel_file_select();
					}
				}
			});
		}
		
		function getRootAndDisplay()
		{
			getRoot(function(dirEntry){
				try {
					getEntries(dirEntry);
				} catch (err)
				{
					alertError(err);
				}
			});
		}

		function getRoot(onGetRoot)
		{
			if (typeof window.requestFileSystem != 'undefined') {
				window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem){
					if (typeof onGetRoot != 'undefined')
						onGetRoot(fileSystem.root);
				}, function(){
					log("Error accessing local file system");
				});
			}
			
			return null;
		}
		
		function upOneLevel()
		{
			if (currEntry == null)
				return;
			currEntry.getParent(function(parentArg){
				getEntries(parentArg);
			}, function(error){
				alert("Error getting parent folder");
			})
		}
		
		function getEntries(dirEntry)
		{
			if (dirEntry == null)
				return;
			
			currPath = dirEntry.fullPath;
			currEntry = dirEntry;
			$("#curr_folder").html(currPath);
			var dirReader = dirEntry.createReader();
			dirReader.readEntries(function(entries){
				displayEntries(entries);			
			}, function(err){
				if (typeof err.message != 'undefined')
					err = err.message;
				alert(err);	
			});
		}
		
		function displayEntries(entriesArray)
		{
			entriesArray.sort(function(a,b){
				var str1 = a.name.toLowerCase();
				var str2 = b.name.toLowerCase();
				if (str1 < str2)
					return -1;
				if (str1 > str2)
					return 1;
				return 0;
			});

			var strD = "D";
			var strF = "F";
			strD = '<img class="EntryTypeIcon" src="imgs/folder.png" />';
			strF = '<img class="EntryTypeIcon" src="imgs/file.png" />';
			
			$("#fileBrowser_entries").empty();
			var table = $("<table id='file_entry_table'></table>").appendTo("#fileBrowser_entries");
			
			var row = $("<tr class='file_list_row'>"+strD+"<td>..</td></tr>").appendTo(table);
			$(row).click(function(event){
				upOneLevel();
			});
			
			for (var i in entriesArray)
			{
				var isFolder = entriesArray[i].isDirectory;
				var name = entriesArray[i].name;
				
				if (file_Browser_params.directory_browser && !isFolder)
					continue;
				
				var row = $("<tr class='file_list_row'></tr>").appendTo(table);
				$(row).data("entry", entriesArray[i]);
				
				$("<td class='file_icon'>" + (isFolder ? strD : strF) + "</td>").appendTo(row);
				$("<td class='file_name'>" + name + "</td>").appendTo(row);
				$(row).click(function(event){
					var entryData = $(this).data("entry");
					if (entryData.isDirectory) {
						if (file_Browser_params.on_folder_select != null)
						{
							var ret = file_Browser_params.on_folder_select(entryData);
							if (ret == false) {
								bClosingDialogByCallbackRequest = true;
								$('.ui-dialog').dialog('close');
								return;
							}
						}
						getEntries(entryData);
					} else if (file_Browser_params.on_file_select != null)
					{
						var bAbort = false;
						if( file_Browser_params.confirm_selected_file ) {
							var strPrompt = file_Browser_params.confirm_selected_file_prompt + " " + entryData.name;
							if( !confirm(strPrompt) ) {
								bAbort = true;
							}
						}

						if( !bAbort ) {
							var ret = file_Browser_params.on_file_select(entryData);
							if (ret == false) {
								bClosingDialogByCallbackRequest = true;
								$('.ui-dialog').dialog('close');
								return;
							}
						}
					}
				});
			}
		}
		
		function alertError(err){
			if (typeof err.message != 'undefined')
				err = err.message;
			alert(err);
		}
		
		init();
	</script>
</div>

